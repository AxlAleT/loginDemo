<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda de Artículos - Papelio</title>
    <link href="https://fonts.googleapis.com/css?family=Karla:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/4.8.95/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/panel-styles.css}">
    <link rel="icon" type="image/x-icon" th:href="@{/images/favicon.ico}">
    <style>
        .search-results {
            max-height: 600px;
            overflow-y: auto;
        }
        .article-card {
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .article-card:hover {
            transform: translateY(-5px);
        }
        .tab-content {
            padding: 20px 0;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .author-chip {
            background-color: #e9ecef;
            border-radius: 16px;
            padding: 2px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            font-size: 13px;
        }
        .article-abstract {
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }
        .badge-year {
            background-color: #05344f;
            color: white;
        }
        .badge-citations {
            background-color: #6c757d;
            color: white;
        }
        #articleModal .modal-dialog {
            max-width: 800px;
        }
    </style>
</head>

<body>
<div class="container mt-5">
    <div class="panel-card">
        <div class="card-body">
            <div class="panel-header">
                <div>
                    <div class="panel-wrapper">
                        <img th:src="@{/images/logo.png}" alt="logo" class="logo">
                    </div>
                    <h2 class="panel-card-title">Búsqueda de Artículos Científicos</h2>
                </div>
                <div>
                    <a th:href="@{/user}" class="btn panel-action-secondary mr-2">Dashboard</a>
                    <form id="logout-form" th:action="@{/logout}" method="post" class="d-inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn panel-action-danger">Cerrar Sesión</button>
                    </form>
                </div>
            </div>

            <!-- Pestañas de navegación -->
            <ul class="nav nav-tabs" id="searchTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="basic-tab" data-toggle="tab" href="#basic" role="tab">Búsqueda Básica</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="advanced-tab" data-toggle="tab" href="#advanced" role="tab">Búsqueda Avanzada</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab">Historial</a>
                </li>
            </ul>

            <!-- Contenido de las pestañas -->
            <div class="tab-content" id="searchTabsContent">
                <!-- Búsqueda Básica -->
                <div class="tab-pane fade show active" id="basic" role="tabpanel">
                    <div class="form-group">
                        <input type="text" id="basicQuery" class="form-control" placeholder="Ingresa palabras clave para buscar artículos...">
                    </div>
                    <button id="basicSearchBtn" class="btn panel-btn">Buscar</button>
                </div>

                <!-- Búsqueda Avanzada -->
                <div class="tab-pane fade" id="advanced" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="advancedQuery">Palabras clave</label>
                                <input type="text" id="advancedQuery" class="form-control" placeholder="Palabras clave...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="authors">Autores</label>
                                <input type="text" id="authors" class="form-control" placeholder="Nombres de autores separados por comas...">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearFrom">Año desde</label>
                                <input type="number" id="yearFrom" class="form-control" placeholder="Ej: 2010">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearTo">Año hasta</label>
                                <input type="number" id="yearTo" class="form-control" placeholder="Ej: 2024">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="sort">Ordenar por</label>
                                <select id="sort" class="form-control">
                                    <option value="relevance">Relevancia</option>
                                    <option value="citations">Citaciones</option>
                                    <option value="year">Año (más reciente)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="advancedSearchBtn" class="btn panel-btn">Buscar</button>
                </div>

                <!-- Historial de Búsqueda -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div id="searchHistoryContent">
                        <div class="text-center">
                            <p>Cargando historial de búsqueda...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicador de carga -->
            <div id="loader" class="loader"></div>

            <!-- Resultados de búsqueda -->
            <div id="searchResults" class="search-results mt-4"></div>
        </div>
    </div>
</div>

<!-- Modal para detalles del artículo -->
<div class="modal fade" id="articleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Artículo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="articleDetails">
                <!-- Los detalles del artículo se cargarán aquí -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn panel-action-secondary" data-dismiss="modal">Cerrar</button>
                <a id="viewFullArticle" href="#" target="_blank" class="btn panel-action-primary">Ver Artículo Completo</a>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Obtener el token CSRF para las solicitudes POST
    const csrfToken = /*[[${_csrf.token}]]*/;
    const csrfHeader = /*[[${_csrf.headerName}]]*/;

    $(document).ready(function() {
        // Configurar el encabezado CSRF para todas las solicitudes AJAX
        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            }
        });

        // Eventos de búsqueda
        $('#basicSearchBtn').click(function() {
            const query = $('#basicQuery').val().trim();
            if (query) {
                performSearch(query, false);
            }
        });

        $('#advancedSearchBtn').click(function() {
            performAdvancedSearch();
        });

        // También buscar al presionar Enter en los campos de búsqueda
        $('#basicQuery').keypress(function(e) {
            if (e.which === 13) {
                $('#basicSearchBtn').click();
            }
        });

        // Cargar historial cuando se cambia a la pestaña
        $('#history-tab').on('shown.bs.tab', function() {
            loadSearchHistory();
        });

        // Función para realizar búsqueda básica
        function performSearch(query, isAdvanced = false) {
            // Mostrar indicador de carga
            $('#loader').show();
            $('#searchResults').empty();

            const endpoint = isAdvanced ? '/api/search/advanced' : '/api/search';
            const payload = { query: query };

            // Para búsquedas avanzadas, añadir filtros adicionales
            if (isAdvanced) {
                const authors = $('#authors').val();
                const yearFrom = $('#yearFrom').val();
                const yearTo = $('#yearTo').val();
                const sort = $('#sort').val();

                if (authors) payload.authors = authors;
                if (yearFrom) payload.yearFrom = parseInt(yearFrom);
                if (yearTo) payload.yearTo = parseInt(yearTo);
                if (sort) payload.sort = sort;
            }

            $.ajax({
                url: endpoint,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    displayResults(response);
                },
                error: function(error) {
                    $('#searchResults').html(`
                        <div class="alert panel-alert-danger">
                            Ha ocurrido un error al realizar la búsqueda. Por favor, intenta de nuevo.
                        </div>
                    `);
                    console.error('Error en la búsqueda:', error);
                },
                complete: function() {
                    $('#loader').hide();
                }
            });
        }

        // Función para realizar búsqueda avanzada
        function performAdvancedSearch() {
            const query = $('#advancedQuery').val().trim();
            if (query) {
                performSearch(query, true);
            }
        }

        // Función para mostrar resultados
        function displayResults(response) {
            if (!response || !response.articles || response.articles.length === 0) {
                $('#searchResults').html(`
                    <div class="alert panel-alert-danger">
                        No se encontraron resultados para tu búsqueda.
                    </div>
                `);
                return;
            }

            let resultsHtml = `
                <h4 class="mb-3">Se encontraron ${response.total} resultados</h4>
                <div class="row">
            `;

            response.articles.forEach(article => {
                // Preparar lista de autores para mostrar
                let authorsHtml = '';
                if (article.authors && article.authors.length > 0) {
                    article.authors.slice(0, 3).forEach(author => {
                        authorsHtml += `<span class="author-chip">${author}</span>`;
                    });

                    if (article.authors.length > 3) {
                        authorsHtml += `<span class="author-chip">+${article.authors.length - 3} más</span>`;
                    }
                }

                // Construir tarjeta de artículo
                resultsHtml += `
                    <div class="col-md-6 mb-4">
                        <div class="panel-card article-card" data-id="${article.id}">
                            <div class="card-body">
                                <h5 class="card-title">${article.title}</h5>
                                <div class="mb-2">
                                    ${authorsHtml}
                                </div>
                                <div class="mb-2">
                                    <span class="badge badge-year">${article.year || 'N/A'}</span>
                                    <span class="badge badge-citations">${article.citationCount || 0} citaciones</span>
                                </div>
                                <p class="article-abstract">${article.abstract || 'No hay resumen disponible para este artículo.'}</p>
                                <button class="btn panel-btn btn-sm view-details" data-id="${article.id}">Ver Detalles</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsHtml += '</div>';
            $('#searchResults').html(resultsHtml);

            // Añadir evento para ver detalles
            $('.view-details').click(function() {
                const articleId = $(this).data('id');
                loadArticleDetails(articleId);
            });
        }

        // Función para cargar detalles de un artículo
        function loadArticleDetails(articleId) {
            $('#loader').show();

            $.ajax({
                url: `/api/search/article/${articleId}`,
                method: 'GET',
                success: function(article) {
                    // Construir HTML para detalles del artículo
                    let detailsHtml = `
                        <h4>${article.title}</h4>
                        <div class="my-3">
                            <strong>Autores:</strong><br>
                    `;

                    if (article.authors && article.authors.length > 0) {
                        article.authors.forEach(author => {
                            detailsHtml += `<span class="author-chip">${author}</span>`;
                        });
                    } else {
                        detailsHtml += '<span>No disponible</span>';
                    }

                    detailsHtml += `
                        </div>
                        <div class="my-3">
                            <strong>Año:</strong> ${article.year || 'No disponible'}<br>
                            <strong>Citaciones:</strong> ${article.citationCount || 0}<br>
                            <strong>DOI:</strong> ${article.doi || 'No disponible'}<br>
                            <strong>Revista:</strong> ${article.venue || 'No disponible'}
                        </div>
                        <div class="my-3">
                            <strong>Resumen:</strong>
                            <p>${article.abstract || 'No hay resumen disponible para este artículo.'}</p>
                        </div>
                    `;

                    if (article.keywords && article.keywords.length > 0) {
                        detailsHtml += `
                            <div class="my-3">
                                <strong>Palabras clave:</strong><br>
                        `;

                        article.keywords.forEach(keyword => {
                            detailsHtml += `<span class="author-chip">${keyword}</span>`;
                        });

                        detailsHtml += '</div>';
                    }

                    // Mostrar detalles en el modal
                    $('#articleDetails').html(detailsHtml);

                    // Configurar enlace para ver artículo completo
                    if (article.url) {
                        $('#viewFullArticle').attr('href', article.url).show();
                    } else {
                        $('#viewFullArticle').hide();
                    }

                    // Mostrar modal
                    $('#articleModal').modal('show');
                },
                error: function(error) {
                    console.error('Error al cargar detalles del artículo:', error);
                    alert('No se pudieron cargar los detalles del artículo.');
                },
                complete: function() {
                    $('#loader').hide();
                }
            });
        }

        // Función para cargar historial de búsqueda
        function loadSearchHistory() {
            $.ajax({
                url: '/api/search/history',
                method: 'GET',
                success: function(history) {
                    if (!history || history.length === 0) {
                        $('#searchHistoryContent').html(`
                            <div class="alert panel-alert-secondary">
                                No hay búsquedas recientes en tu historial.
                            </div>
                        `);
                        return;
                    }

                    let historyHtml = `
                        <table class="panel-table">
                            <thead>
                                <tr>
                                    <th>Consulta</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    history.forEach(item => {
                        const date = new Date(item.searchDate).toLocaleString();
                        const query = item.query;
                        const isAdvanced = query.startsWith('Advanced:');

                        historyHtml += `
                            <tr>
                                <td>${query}</td>
                                <td>${date}</td>
                                <td>
                                    <button class="btn panel-action-btn panel-action-primary repeat-search"
                                            data-query="${query}"
                                            data-advanced="${isAdvanced}">
                                        Repetir
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    historyHtml += `
                            </tbody>
                        </table>
                    `;

                    $('#searchHistoryContent').html(historyHtml);

                    // Añadir evento para repetir búsqueda
                    $('.repeat-search').click(function() {
                        const query = $(this).data('query');
                        const isAdvanced = $(this).data('advanced') === true;

                        // Limpiar el prefijo "Advanced:" si existe
                        const cleanQuery = isAdvanced && query.startsWith('Advanced:')
                            ? query.substring(9).trim()
                            : query;

                        if (isAdvanced) {
                            $('#advanced-tab').tab('show');
                            $('#advancedQuery').val(cleanQuery);
                            setTimeout(() => {
                                performAdvancedSearch();
                            }, 300);
                        } else {
                            $('#basic-tab').tab('show');
                            $('#basicQuery').val(cleanQuery);
                            setTimeout(() => {
                                $('#basicSearchBtn').click();
                            }, 300);
                        }
                    });
                },
                error: function(error) {
                    $('#searchHistoryContent').html(`
                        <div class="alert panel-alert-danger">
                            Error al cargar el historial de búsqueda.
                        </div>
                    `);
                    console.error('Error al cargar historial:', error);
                }
            });
        }
    });
    /*]]>*/
</script>
</body>
</html>